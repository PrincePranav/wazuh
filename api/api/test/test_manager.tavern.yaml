---
test_name: GET /manager/status

stages:

  - name: Request

    request:
      url: http://localhost:55000/manager/status
      method: GET

    response:
      status_code: 200
      body:
        data:
          ossec-agentlessd: !anystr
          ossec-analysisd: !anystr
          ossec-authd: !anystr
          ossec-csyslogd: !anystr
          ossec-dbd: !anystr
          ossec-monitord: !anystr
          ossec-execd: !anystr
          ossec-integratord: !anystr
          ossec-logcollector: !anystr
          ossec-maild: !anystr
          ossec-remoted: !anystr
          ossec-reportd: !anystr
          ossec-syscheckd: !anystr
          wazuh-clusterd: !anystr
          wazuh-modulesd: !anystr

---
test_name: GET /manager/info

stages:

  - name: Request

    request:
      url: http://localhost:55000/manager/info

    response:
      status_code: 200
      body:
        data:
          path: !anystr
          version: !anystr
          compilation_date: !anystr
          type: !anystr
          max_agents: !anystr
          openssl_support: !anystr
          ruleset_version: !anystr
          tz_offset: !anystr
          tz_name: !anystr

---
test_name: GET /manager/configuration

stages:

  - name: Request

    request:
      url: http://localhost:55000/manager/configuration

    response:
      status_code: 200
      body:
        data:
          auth: !anything
          cis-cat: !anything
          cluster: !anything
          command: !anything
          global: !anything
          localfile: !anything
          open-scap: !anything
          osquery: !anything
          remote: !anything
          rootcheck: !anything
          ruleset: !anything
          syscheck: !anything
          syscollector: !anything
          vulnerability-detector: !anything

---
test_name: GET /manager/stats

stages:

  - name: Manager stats

    request:
      url: http://localhost:55000/manager/stats
      method: GET

    response:
        status_code: 200
        body:
          data: !anything

  - name: Hourly stats

    request:
      url: http://localhost:55000/manager/stats/hourly
      method: GET

    response:
        status_code: 200
        body:
          data:
            averages: !anything
            interactions: !anyint

  - name: Weekly stats

    request:
      url: http://localhost:55000/manager/stats/weekly
      method: GET

    response:
        status_code: 200
        body:
          data:
            Mon:
              hours: !anything
              interactions: !anyint
            Tue:
              hours: !anything
              interactions: !anyint
            Wed:
              hours: !anything
              interactions: !anyint
            Thu:
              hours: !anything
              interactions: !anyint
            Fri:
              hours: !anything
              interactions: !anyint
            Sat:
              hours: !anything
              interactions: !anyint
            Sun:
              hours: !anything
              interactions: !anyint

  - name: Analysisd stats

    request:
      url: http://localhost:55000/manager/stats/analysisd
      method: GET

    response:
        status_code: 200
        body:
          data:
            total_events_decoded: !anyfloat
            syscheck_events_decoded: !anyfloat
            syscheck_edps: !anyfloat
            syscollector_events_decoded: !anyfloat
            syscollector_edps: !anyfloat
            rootcheck_events_decoded: !anyfloat
            rootcheck_edps: !anyfloat
            sca_events_decoded: !anyfloat
            sca_edps: !anyfloat
            hostinfo_events_decoded: !anyfloat
            hostinfo_edps: !anyfloat
            winevt_events_decoded: !anyfloat
            winevt_edps: !anyfloat
            other_events_decoded: !anyfloat
            other_events_edps: !anyfloat
            events_processed: !anyfloat
            events_edps: !anyfloat
            events_received: !anyfloat
            events_dropped: !anyfloat
            alerts_written: !anyfloat
            firewall_written: !anyfloat
            fts_written: !anyfloat
            syscheck_queue_usage: !anyfloat
            syscheck_queue_size: !anyfloat
            syscollector_queue_usage: !anyfloat
            syscollector_queue_size: !anyfloat
            rootcheck_queue_usage: !anyfloat
            rootcheck_queue_size: !anyfloat
            sca_queue_usage: !anyfloat
            sca_queue_size: !anyfloat
            hostinfo_queue_usage: !anyfloat
            hostinfo_queue_size: !anyfloat
            winevt_queue_usage: !anyfloat
            winevt_queue_size: !anyfloat
            event_queue_usage: !anyfloat
            event_queue_size: !anyfloat
            rule_matching_queue_usage: !anyfloat
            rule_matching_queue_size: !anyfloat
            alerts_queue_usage: !anyfloat
            alerts_queue_size: !anyfloat
            firewall_queue_usage: !anyfloat
            firewall_queue_size: !anyfloat
            statistical_queue_usage: !anyfloat
            statistical_queue_size: !anyfloat
            archives_queue_usage: !anyfloat
            archives_queue_size: !anyfloat

  - name: Remoted stats

    request:
      url: http://localhost:55000/manager/stats/remoted
      method: GET

    response:
        status_code: 200
        body:
          data:
            queue_size: !anyfloat
            total_queue_size: !anyfloat
            tcp_sessions: !anyfloat
            evt_count: !anyfloat
            ctrl_msg_count: !anyfloat
            discarded_count: !anyfloat
            msg_sent: !anyfloat
            recv_bytes: !anyfloat

---
test_name: GET /manager/logs
strict:
  - body

stages:

  - name: Request

    request:
      url: http://localhost:55000/manager/logs
      method: GET

    response:
        status_code: 200
        body:
          data:
            items: !anything
            totalItems: !anyint

  - name: Filters -> limit=4

    request:
      url: http://localhost:55000/manager/logs
      method: GET
      params:
        limit: 4

    response:
        status_code: 200
        body:
          data:
            items:
              - &manager_log
                description: !anystr
                level: !anystr
                tag: !anystr
                timestamp: !anystr
              - <<: *manager_log
              - <<: *manager_log
              - <<: *manager_log
            totalItems: !anyint

  - name: Filters -> limit=2, sort=-level

    request:
      url: http://localhost:55000/manager/logs
      method: GET
      params:
        limit: 2
        sort: -level

    response:
        status_code: 200
        body:
          data:
            items:
              - <<: *manager_log
              - <<: *manager_log
            totalItems: !anyint

  - name: Filters -> offset=3, limit=3

    request:
      url: http://localhost:55000/manager/logs
      method: GET
      params:
        limit: 3
        offset: 3

    response:
        status_code: 200
        body:
          data:
            items:
              - <<: *manager_log
              - <<: *manager_log
              - <<: *manager_log
            totalItems: !anyint

  - name: Filters -> offset=3, type_log=info, limit=4

    request:
      url: http://localhost:55000/manager/logs
      method: GET
      params:
        limit: 4
        offset: 3
        type_log: info

    response:
        status_code: 200
        body:
          data:
            items:
              - <<: *manager_log
              - <<: *manager_log
              - <<: *manager_log
              - <<: *manager_log
            totalItems: !anyint

  - name: Filters -> category=ossec-analysisd, limit=1

    request:
      url: http://localhost:55000/manager/logs
      method: GET
      params:
        category: ossec-analysisd
        limit: 1

    response:
        status_code: 200
        body:
          data:
            items:
              - <<: *manager_log
            totalItems: !anyint

  - name: Filters -> category=ossec-syscheckd, limit=1

    request:
      url: http://localhost:55000/manager/logs
      method: GET
      params:
        category: ossec-syscheckd
        limit: 1

    response:
        status_code: 200
        body:
          data:
            items:
              - <<: *manager_log
            totalItems: !anyint

---
test_name: GET /manager/logs/summary

stages:

  - name: Request

    request:
      url: http://localhost:55000/manager/logs/summary

    response:
      status_code: 200
      body:
        data:
          ossec-agentlessd: !anything
          ossec-analysisd: !anything
          ossec-authd: !anything
          ossec-authd: !anything
          ossec-csyslogd: !anything
          ossec-dbd: !anything
          ossec-execd: !anything
          ossec-integratord: !anything
          ossec-logcollector: !anything
          ossec-monitord: !anything
          ossec-remoted: !anything
          ossec-rootcheck: !anything
          ossec-syscheckd: !anything
          wazuh-db: !anything
          wazuh-modulesd: !anything
          wazuh-modulesd:ciscat: !anything
          wazuh-modulesd:database: !anything
          wazuh-modulesd:download: !anything
          wazuh-modulesd:oscap: !anything
          wazuh-modulesd:osquery: !anything
          wazuh-modulesd:syscollector: !anything

---
test_name: GET /manager/files

stages:

  - name: Get ossec.conf

    request:
      url: http://localhost:55000/manager/files
      params:
        path: etc/ossec.conf

    response:
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Get local rules

    request:
      url: http://localhost:55000/manager/files
      params:
        path: etc/rules/local_rules.xml

    response:
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Get local decoder

    request:
      url: http://localhost:55000/manager/files
      params:
        path: etc/decoders/local_decoder.xml

    response:
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Get CDB list

    request:
      url: http://localhost:55000/manager/files
      params:
        path: etc/lists/audit-keys

    response:
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Get file with wrong path

    request:
      url: http://localhost:55000/manager/files
      params:
        path: wrong_path/file.xml

    response:
      status_code: 400
      body:
        detail: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Get file with empty path

    request:
      url: http://localhost:55000/manager/files
      params:
        path:

    response:
      status_code: 400
      body:
        detail: !anystr
        status: 400
        title: !anystr
        type: !anystr

---
test_name: POST /manager/files

stages:

  #### Save ossec.conf
  - name: Get ossec.conf

    request:
      url: http://localhost:55000/manager/files
      params:
        path: etc/ossec.conf

    response:
      save:
        body:
          ossec_conf: data.contents
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Upload ossec.conf

    request:
      url: http://localhost:55000/manager/files
      data: "{ossec_conf}"
      headers:
        content-type: application/octet-stream
      params:
        overwrite: True
        path: etc/ossec.conf

    response:
      status_code: 200
      body:
        data:
         contents: !anystr

  - name: Upload new rules

    request:
      url: http://localhost:55000/manager/files
      method: POST
      data: "<!-- Local rules -->\n <group name=\"local,\">\n    <!--   NEW RULE    -->\n    <rule id=\"111111\" level=\"5\">\n      <if_sid>5716</if_sid>\n      <srcip>1.1.1.1</srcip>\n      <description>sshd: authentication failed from IP 1.1.1.1.</description>\n      <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>\n    </rule>\n  </group>\n"
      headers:
        content-type: application/octet-stream
      params:
        path: etc/rules/new-rules.xml

    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload rules (overwrite=false)

    request:
      url: http://localhost:55000/manager/files
      method: POST
      data: "<!-- Local rules -->\n <group name=\"local,\">\n <!--   NEW RULE    -->\n <rule id=\"111111\" level=\"5\">\n <if_sid>5716</if_sid>\n <srcip>1.1.1.1</srcip>\n  <description>sshd: authentication failed from IP 1.1.1.1.</description>\n <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>\n </rule>\n </group>\n"
      headers:
        content-type: application/octet-stream
      params:
        path: etc/rules/new-rules.xml
        overwrite: False

    response:
      status_code: 400
      body:
        code: 1905
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Upload rules (overwrite=true)

    request:
      url: http://localhost:55000/manager/files
      method: POST
      data: "<!-- Local rules -->\n <group name=\"local,\">\n <!--   NEW RULE    -->\n <rule id=\"111111\" level=\"5\">\n <if_sid>5716</if_sid>\n <srcip>1.1.1.1</srcip>\n  <description>sshd: authentication failed from IP 1.1.1.1.</description>\n <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>\n </rule>\n </group>\n"
      headers:
        content-type: application/octet-stream
      params:
        path: etc/rules/new-rules.xml
        overwrite: True

    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload new decoder

    request:
      url: http://localhost:55000/manager/files
      method: POST
      data: "<!-- NEW Local Decoders -->\n <decoder name=\"local_decoder_example\">\n <program_name>NEW DECODER</program_name>\n </decoder>\n"
      headers:
        content-type: application/octet-stream
      params:
        path: etc/decoders/new-decoder.xml

    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload decoder (overwrite=false)

    request:
      url: http://localhost:55000/manager/files
      method: POST
      data: "<!-- NEW Local Decoders -->\n <decoder name=\"local_decoder_example\">\n <program_name>NEW DECODER</program_name>\n </decoder>\n"
      headers:
        content-type: application/octet-stream
      params:
        path: etc/decoders/new-decoder.xml
        overwrite: False

    response:
      status_code: 400
      body:
        code: 1905
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Upload decoder (overwrite=true)

    request:
      url: http://localhost:55000/manager/files
      method: POST
      data: "<!-- NEW Local Decoders -->\n <decoder name=\"local_decoder_example\">\n <program_name>NEW DECODER</program_name>\n </decoder>\n"
      headers:
        content-type: application/octet-stream
      params:
        path: etc/decoders/new-decoder.xml
        overwrite: True

    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload new CDB list

    request:
      url: http://localhost:55000/manager/files
      method: POST
      data: "test-wazuh-w:write\ntest-wazuh-r:read\ntest-wazuh-a:attribute\ntest-wazuh-x:execute\ntest-wazuh-c:command\n"
      headers:
        content-type: application/octet-stream
      params:
        path: etc/lists/new-list

    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload CDB list (overwrite=false)

    request:
      url: http://localhost:55000/manager/files
      method: POST
      data: "test-wazuh-w:write\ntest-wazuh-r:read\ntest-wazuh-a:attribute\ntest-wazuh-x:execute\ntest-wazuh-c:command\n"
      headers:
        content-type: application/octet-stream
      params:
        path: etc/lists/new-list
        overwrite: False

    response:
      status_code: 400
      body:
        code: 1905
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Upload CDB list (overwrite=true)

    request:
      url: http://localhost:55000/manager/files
      method: POST
      data: "test-wazuh-w:write\ntest-wazuh-r:read\ntest-wazuh-a:attribute\ntest-wazuh-x:execute\ntest-wazuh-c:command\n"
      headers:
        content-type: application/octet-stream
      params:
        path: etc/lists/new-list
        overwrite: True

    response:
      status_code: 200
      body:
        message: !anystr

---
test_name: DELETE /manager/files

stages:

  - &delete_rules_file
    name: Delete rules file

    request:
      url: http://localhost:55000/manager/files
      method: DELETE
      params:
        path: etc/rules/new-rules.xml

    response:
      status_code: 200
      body:
        message: !anystr

  - name: Delete unexisting rules file

    request:
      url: http://localhost:55000/manager/files
      method: DELETE
      params:
        path: etc/rules/new-rules.xml

    response:
      status_code: 500  ## should be 400
      body:
        code: 1000
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 500
        title: !anystr
        type: !anystr

  - name: Delete decoder file

    request:
      url: http://localhost:55000/manager/files
      method: DELETE
      params:
        path: etc/decoders/new-decoder.xml

    response:
      status_code: 200
      body:
        message: !anystr

  - name: Delete unexisting decoder file

    request:
      url: http://localhost:55000/manager/files
      method: DELETE
      params:
        path: etc/decoders/new-decoder.xml

    response:
      status_code: 500  ## should be 400
      body:
        code: 1000
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 500
        title: !anystr
        type: !anystr

  - name: Delete CDB list file

    request:
      url: http://localhost:55000/manager/files
      method: DELETE
      params:
        path: etc/lists/new-list

    response:
      status_code: 200
      body:
        message: !anystr

  - name: Delete unexisting CDB list file

    request:
      url: http://localhost:55000/manager/files
      method: DELETE
      params:
        path: etc/lists/new-list

    response:
      status_code: 500  ## should be 400
      body:
        code: 1000
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 500
        title: !anystr
        type: !anystr

---
test_name: GET /manager/configuration/validation (OK)

stages:

  - &manager_validation
    name: Request validation

    request:
      url: http://localhost:55000/manager/configuration/validation

    response:
      status_code: 200
      body:
        status: OK

---
test_name: GET /manager/validation (KO)

stages:

  #### Upload corrupted rules file
  - name: Upload new rules

    request:
      url: http://localhost:55000/manager/files
      method: POST
      data: "<!-- Local rules -->\n <group name=\"local,\">\n <!--   NEW RULE    -->\n  <rule id=\"111111\" level=\"XXX\">\n      <if_sid>5716</if_sid>\n      <srcip>1.1.1.1</srcip>\n      <description>sshd: authentication failed from IP 1.1.1.1.</description>\n      <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>\n    </rule>\n  </group>\n"
      headers:
        content-type: application/octet-stream
      params:
        path: etc/rules/new-rules.xml

       response:
        status_code: 200
        body:
          message: !anystr
  
  - *manager_validation

---
test_name: PUT /manager/restart

stages:

  - name: Restart manager

    request:
      url: http://localhost:55000/manager/restart
      method: PUT

    response:
      status_code: 200
      body:
        message: !anystr
