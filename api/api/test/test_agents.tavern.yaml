---
test_name: DELETE /agents

marks:
  - usefixtures:
      - agents_test

stages:
  - name: Try remove not existing agents

    request:
      url: http://localhost:55000/agents
      method: DELETE
      params:
        list_agents_ids: 998,999

    response:
      status_code: 200
      body:
        affected_agents: []
        failed_ids:
          - error:
              code: 1701
              message: !anystr
              remediation: !anystr
            id: '998'
          - error:
              code: 1701
              message: !anystr
              remediation: !anystr
            id: '999'
        message: Some agents were not removed
        older_than: 7d
        total_affected_agents: 0
        total_failed_ids: 2
    
  - name: Try remove agent 000 (manager)

    request:
      url: http://localhost:55000/agents
      method: DELETE
      params:
        list_agents_ids: '000'

    response:
      status_code: 200
      body:
        affected_agents: []
        failed_ids:
          - error:
              code: 1703
              message: !anystr
              remediation: !anystr
            id: '000'
        message: Some agents were not removed
        older_than: 7d
        total_affected_agents: 0
        total_failed_ids: 1

  - name: Try remove agent by name

    request:
      url: http://localhost:55000/agents
      method: DELETE
      params:
        list_agents_ids: bad_id

    response:
      status_code: 400
      body:
        detail: !anystr
        status: 400
        title: Bad Request
        type: about:blank

  - name: Remove agents

    request:
      url: http://localhost:55000/agents
      method: DELETE
      params:
        list_agents_ids: 004,005
        older_than: '1s'
        purge: True

    response:
      status_code: 200
      body:
        affected_agents: ["004","005"]
        message: All selected agents were removed
        older_than: 1s
        total_affected_agents: 2

---
test_name: DELETE /agents/:agent_id

marks:
  - usefixtures:
      - agents_test

stages:
  - name: Try remove agent 000 (manager)

    request:
      url: http://localhost:55000/agents/000
      method: DELETE

    response: &error_delete_agent
      status_code: 200
      body:
        affected_agents: []
        failed_ids:
          - error:
              code: 1703
              message: !anystr
              remediation: !anystr
            id: '000'
        message: Some agents were not removed

  - name: Try remove not existing agent

    request:
      url: http://localhost:55000/agents/999
      method: DELETE

    response:
      <<: *error_delete_agent
      body:
        failed_ids:
          - id: '999'

  - name: Try remove agent by name

    request:
      url: http://localhost:55000/agents/bad_id
      method: DELETE

    response:
      status_code: 400
      body:
        detail: !anystr
        status: 400
        title: Bad Request
        type: about:blank

  - name: Remove an agent

    request:
      url: http://localhost:55000/agents/006
      method: DELETE
      params:
        purge: True

    response:
      status_code: 200
      body:
        affected_agents: ["006"]
        message: All selected agents were removed


---
test_name: DELETE /agents/:agent_id/group

marks:
  - usefixtures:
      - agents_test

stages:
  - name: Try remove group from agent 000 (manager)

    request:
      url: http://localhost:55000/agents/000/group
      method: DELETE

    response:
      status_code: 400
      body:
        code: 1734
        dapi_errors:
          master-node:
            "error": "Error unsetting agent group: Agent 000 doesn't belong to any group"
            "logfile": "WAZUH_HOME/logs/api.log"
        detail: "Error unsetting agent group: Agent 000 doesn't belong to any group"
        remediation: "Agent does not belong to any group, to add the agent to a group follow: [official documentation](https://documentation.wazuh.com/3.x/user-manual/agents/grouping-agents.html)"
        status: 400
        title: "Wazuh Error"
        type: "about:blank"

  - name: Try remove group not exist agent

    request:
      url: http://localhost:55000/agents/999/group
      method: DELETE

    response:
      status_code: 400
      body:
        code: 1701
        dapi_errors:
          master-node:
            "error": "Agent does not exist: 999"
            "logfile": "WAZUH_HOME/logs/api.log"
        detail: "Agent does not exist: 999"
        remediation: "Please, make the following call to find all available agent `curl -u foo:bar -X GET \"http://localhost:55000/agents?select=id\"`"
        status: 400
        title: "Wazuh Error"
        type: "about:blank"

  - name: Try remove group bad agent ID

    request:
      url: http://localhost:55000/agents/bad_id/group
      method: DELETE

    response:
      status_code: 400
      body:
        detail: !anystr
        status: 400
        title: Bad Request
        type: about:blank

  - name: Remove groups

    request:
      url: http://localhost:55000/agents/001/group
      method: DELETE
      params:
        purge: True

    response:
      status_code: 200
      body:
        message: Group unset for agent '001'.

---
test_name: DELETE /agents/:agent_id/group/:group_id

marks:
  - usefixtures:
      - agents_test

stages:
  - name: Try remove group from agent 000 (manager)

    request:
      url: http://localhost:55000/agents/000/group/dmz
      method: DELETE

    response:
      status_code: 400
      body:
        code: 1734
        dapi_errors:
          master-node:
            "error": "Error unsetting agent group: Agent 000 doesn't belong to any group"
            "logfile": "WAZUH_HOME/logs/api.log"
        detail: "Error unsetting agent group: Agent 000 doesn't belong to any group"
        remediation: "Agent does not belong to any group, to add the agent to a group follow: [official documentation](https://documentation.wazuh.com/3.x/user-manual/agents/grouping-agents.html)"
        status: 400
        title: "Wazuh Error"
        type: "about:blank"

  - name: Try remove group not exist agent

    request:
      url: http://localhost:55000/agents/999/group/dmz
      method: DELETE

    response:
      status_code: 400
      body:
        code: 1701
        dapi_errors:
          master-node:
            "error": "Agent does not exist: 999"
            "logfile": "WAZUH_HOME/logs/api.log"
        detail: "Agent does not exist: 999"
        remediation: "Please, make the following call to find all available agent `curl -u foo:bar -X GET \"http://localhost:55000/agents?select=id\"`"
        status: 400
        title: "Wazuh Error"
        type: "about:blank"

  - name: Try remove group bad agent ID

    request:
      url: http://localhost:55000/agents/bad_id/group/dmz
      method: DELETE

    response:
      status_code: 400
      body:
        detail: !anystr
        status: 400
        title: Bad Request
        type: about:blank

  - name: Remove not exist group

    request:
      url: http://localhost:55000/agents/001/group/dmz
      method: DELETE
      params:
        purge: True

    response:
      status_code: 400
      body:
        code: 1734
        dapi_errors:
          master-node:
            "error": "Error unsetting agent group: Agent 001 doesn't belong to group dmz"
            "logfile": "WAZUH_HOME/logs/api.log"
        detail: "Error unsetting agent group: Agent 001 doesn't belong to group dmz"
        remediation: "Agent does not belong to any group, to add the agent to a group follow: [official documentation](https://documentation.wazuh.com/3.x/user-manual/agents/grouping-agents.html)"
        status: 400
        title: "Wazuh Error"
        type: "about:blank"

  - name: Create new group

    request:
      url: http://localhost:55000/agents/groups/dmz
      method: PUT

    response:
      status_code: 200
      body:
        message: "Group 'dmz' created."

  - name: Put group to agent

    request:
      url: http://localhost:55000/agents/001/group/dmz
      method: PUT

    response:
      status_code: 200
      body:
        message: "Group 'dmz' added to agent '001'."

  - name: Remove group

    request:
      url: http://localhost:55000/agents/001/group/dmz
      method: DELETE

    response:
      status_code: 200
      body:
        message: "Group 'dmz' unset for agent '001'."

---
test_name: DELETE /agents/group/:group_id

marks:
  - usefixtures:
      - agents_test

stages:
  - name: Try remove not exist group

    request:
      url: http://localhost:55000/agents/group/dmztest
      method: DELETE
      params:
        list_agents: 001,002

    response:
      status_code: 400
      body:
        code: 1710
        dapi_errors:
          master-node:
            "error": "The group does not exist"
            "logfile": "WAZUH_HOME/logs/api.log"
        detail: "The group does not exist"
        remediation: "Please, make the following call to find all available groups `curl -u foo:bar -X GET \"http://localhost:55000/agents/groups\"`"
        status: 400
        title: "Wazuh Error"
        type: "about:blank"

  - name: Create new group

    request:
      url: http://localhost:55000/agents/groups/dmztest
      method: PUT

    response:
      status_code: 200
      body:
        message: "Group 'dmztest' created."

  - name: Put group to agent

    request:
      url: http://localhost:55000/agents/001/group/dmztest
      method: PUT

    response:
      status_code: 200
      body:
        message: "Group 'dmztest' added to agent '001'."

  - name: Try remove group agent 000

    request:
      url: http://localhost:55000/agents/group/dmztest
      method: DELETE
      params:
        list_agents: '000'

    response:
      status_code: 200
      body:
        affected_agents: []
        failed_ids:
          - '000'
        message: Some agents were not removed to group dmztest

  - name: Try remove group not exist agents

    request:
      url: http://localhost:55000/agents/group/dmztest
      method: DELETE
      params:
        list_agents: 998,999

    response:
      status_code: 200
      body:
        affected_agents: []
        failed_ids:
          - '998'
          - '999'
        message: Some agents were not removed to group dmztest

  - name: Remove group

    request:
      url: http://localhost:55000/agents/group/dmztest
      method: DELETE
      params:
        list_agents: '001'

    response:
      status_code: 200
      body:
        affected_agents: 
          - '001'
        message: All selected agents were removed to group dmztest

---
test_name: DELETE /agents/groups

marks:
  - usefixtures:
      - agents_test

stages:
  - name: Try remove not exist groups

    request:
      url: http://localhost:55000/agents/groups
      method: DELETE
      params:
        list_groups: dmztest1,dmztest2

    response:
      status_code: 200
      body:
        affected_agents: []
        failed_ids:
          - error:
              code: 1710
              message: "The group does not exist: dmztest1"
              remediation: "Please, make the following call to find all available groups `curl -u foo:bar -X GET \"http://localhost:55000/agents/groups\"`"
            id: dmztest1
          - error:
              code: 1710
              message: "The group does not exist: dmztest2"
              remediation: "Please, make the following call to find all available groups `curl -u foo:bar -X GET \"http://localhost:55000/agents/groups\"`"
            id: dmztest2
        ids: []
        message: Some groups were not removed

  - name: Create new group

    request:
      url: http://localhost:55000/agents/groups/dmztest1
      method: PUT

    response:
      status_code: 200
      body:
        message: "Group 'dmztest1' created."
    
  - name: Create other new group

    request:
      url: http://localhost:55000/agents/groups/dmztest2
      method: PUT

    response:
      status_code: 200
      body:
        message: "Group 'dmztest2' created."

  - name: Put group 1 to agent

    request:
      url: http://localhost:55000/agents/001/group/dmztest1
      method: PUT

    response:
      status_code: 200
      body:
        message: "Group 'dmztest1' added to agent '001'."

  - name: Put group 2 to agent

    request:
      url: http://localhost:55000/agents/002/group/dmztest2
      method: PUT

    response:
      status_code: 200
      body:
        message: "Group 'dmztest2' added to agent '002'."

  - name: Remove group

    request:
      url: http://localhost:55000/agents/groups
      method: DELETE
      params:
        list_groups: dmztest1,dmztest2

    response:
      status_code: 200
      body:
        affected_agents:
          - '001'
          - '002'
        ids:
          - dmztest1
          - dmztest2
        message: All selected groups were removed

---
test_name: DELETE /agents/groups/:group_id

marks:
  - usefixtures:
      - agents_test

stages:
  - name: Try remove not exist groups

    request:
      url: http://localhost:55000/agents/groups/dmztest1
      method: DELETE

    response:
      status_code: 200
      body:
        affected_agents: []
        failed_ids:
          - error:
              code: 1710
              message: "The group does not exist: dmztest1"
              remediation: "Please, make the following call to find all available groups `curl -u foo:bar -X GET \"http://localhost:55000/agents/groups\"`"
            id: dmztest1
        ids: []
        message: Some groups were not removed

  - name: Create new group

    request:
      url: http://localhost:55000/agents/groups/dmztest1
      method: PUT

    response:
      status_code: 200
      body:
        message: "Group 'dmztest1' created."
    
  - name: Create other new group

    request:
      url: http://localhost:55000/agents/groups/dmztest2
      method: PUT

    response:
      status_code: 200
      body:
        message: "Group 'dmztest2' created."

  - name: Put group to agent

    request:
      url: http://localhost:55000/agents/001/group/dmztest1
      method: PUT

    response:
      status_code: 200
      body:
        message: "Group 'dmztest1' added to agent '001'."

  - name: Remove group

    request:
      url: http://localhost:55000/agents/groups/dmztest1
      method: DELETE

    response:
      status_code: 200
      body:
        affected_agents:
          - '001'
        ids:
          - dmztest1
        message: All selected groups were removed

  - name: Remove other group

    request:
      url: http://localhost:55000/agents/groups/dmztest2
      method: DELETE

    response:
      status_code: 200
      body:
        affected_agents: []
        ids:
          - dmztest2
        message: All selected groups were removed

---
test_name: GET /agents

marks:
  - usefixtures:
      - agents_test

stages:
  - name: Basic response agents

    request: &get_agents
      url: http://localhost:55000/agents
      method: GET

    response:
      status_code: 200
      body:
        items: !anything
        totalItems: !anyint

  - name: Pagination

    request:
      <<: *get_agents
      params:
        offset: 0
        limit: 1

    response:
      status_code: 200
      save:
        body:
          expected_os_platform: items.os.platform
          expected_os_version: items.os.version
          expected_manager_host: items.manager
      body:
        items:
          - status: Active
            id: '000'
        totalItems: !anyint

  - name: Try show agents with limit 0

    request:
      <<: *get_agents
      params:
        limit: 0

    response:
      status_code: 400

  #Solve problems with sort and search params

  - name: Selection

    request:
      <<: *get_agents
      params:
        select: 'dateAdd,mergedSum'

    response:
      status_code: 200
      body:
        items: !anything
        totalItems: !anyint

  - name: Try show agents with not allowed selector

    request:
      <<: *get_agents
      params:
        select: param_test

    response:
      status_code: 400

  - name: Version

    request:
      <<: *get_agents
      params:
        version: 'Wazuhv3.9.0'

    response:
      status_code: 200
      body:
        items: !anything
        totalItems: !anyint

  #Not work properly
  - name: OS Platform

    request:
      <<: *get_agents
      params:
        os_platform: "{expected_os_platform:s}"

    response:
      status_code: 200
      body:
        items: !anything
        totalItems: !anyint

  - name: OS Version

    request:
      <<: *get_agents
      params:
        os_platform: expected_os_version

    response:
      status_code: 200
      body:
        items: !anything
        totalItems: !anyint

  - name: ManagerHost

    request:
      <<: *get_agents
      params:
        manager: expected_manager_host

    response:
      status_code: 200
      body:
        items: !anything
        totalItems: !anyint